<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset=utf-8>
    <link rel="stylesheet" type="text/css" href="themes/jquery-ui-1.9.2.custom.css">
    <link rel="stylesheet" type="text/css" href="css/diffusive.css">

    <script src="scripts/jquery-1.8.3.js"></script>
    <script src="scripts/ui/jquery-ui-1.9.2.custom.js"></script>
    <script type="text/javascript">
        $(function() {
            $( "#tabs" ).tabs();
        });
        $( document ).ready( function()
        {
//            var serverUri = "";
            var serverUri = "http://192.168.1.4:8182";
            var diffusersUri = serverUri + "/diffusers";
            var serializersUri = diffusersUri + "/serializers";
            // request the list of diffusers (atom feed) from the diffuser server
            // <feed xmlns="http://www.w3.org/2005/Atom">
            //     <id>get-diffuser-list</id>
            //     <title type="text">get-diffuser-list</title>
            //     <updated>2012-12-27T21:04:12.694Z</updated>
            //     <link href="http://192.168.1.5:8182/diffusers" rel="self"></link>
            //     <generator uri="http://192.168.1.5:8182/diffusers" version="0.1">org.microtitan.diffusive.diffuser.restful.RestfulDiffuser</generator>
            //     <entry>
            //          <id>org.microtitan.tests.threaded.task:call()-org.microtitan.tests.threaded.Result</id><
            //          title type="text">org.microtitan.tests.threaded.Task:call()-org.microtitan.tests.threaded.Result</title>
            //          <updated>2012-12-27T21:04:12.694Z</updated>
            //          <published>2012-12-27T21:04:12.694Z</published>
            //          <link href="http://192.168.1.5:8182/diffusers/org.microtitan.tests.threaded.Task:call()-org.microtitan.tests.threaded.Result" rel="self"></link>
            //          <summary type="html">&lt;html&gt;&lt;p&gt;RESTful Diffuser for: org.microtitan.tests.threaded.Task:call()-org.microtitan.tests.threaded.Result&lt;/p&gt;&lt;/html&gt;</summary>
            //     </entry>
            //  </feed>
            $.get( diffusersUri, function( xml ) {
                $(xml).find( "entry").each( function( i ) {
                    $( "#diffuser-list" ).append( '<dt>' + $( this ).find( "title" ).text() + '</dt>' );
                    $( "#diffuser-list" ).append( '<dd><p>' +
                            '<a href=' + $( this ).find( "link" ).attr( "href" ) + ' >Diffuser</a></p>' +
                            '<p>Information Request Timestamp: ' + $( this ).find( "published" ).text() + '</p>' +
                            '</dd>' );
                })
            }, "xml" );//.error( function() { alert( 'failed to load diffuser list' ) } );

            $.get( serializersUri, function( xml ) {
                $(xml).find( "entry" ).each( function( i ) {
                    var option = $( this ).find( "title" ).text();
                    if( option === "persistence_xml" ) {
                        $( "#serializer-name-list" ).append( '<option selected>' + option + '</option>' );
                    } else {
                        $( "#serializer-name-list" ).append( '<option>' + option + '</option>' );
                    }
                });

            }, "xml" );//.error( function() { alert( 'failed to load serializer names' ) } );

            // make the item-lists (arguments, end-points, class-paths) sortable through drag and drop
            $( ".sortable" ).sortable();

            // add argument input field and remove-item button to the method's argument list
            $( "#add-arg-type-button" ).click( function() {
                $( "#method-argument-list" ).append( '<li>' +
                        '<span class="ui-icon ui-icon-arrowthick-2-n-s"></span>' +
                        '<input type="text" class="item-list-input" value="">' +
                        '<input type="button" class="item-list-remove-button" value="x">' +
                        '</li>' );
            });

            // add class-path input field and remove-item button to the class-path list
            $( "#add-class-path-button" ).click( function() {
                $( "#class-path-list" ).append( '<li>' +
                        '<span class="ui-icon ui-icon-arrowthick-2-n-s"></span>' +
                        '<input type="text" class="item-list-input" value="">' +
                        '<input type="button" class="item-list-remove-button" value="x">' +
                        '</li>' );
            });

            // add end-point input field and remove-item button to the end-point list
            $( "#add-end-points-button" ).click( function() {
                $( "#end-points-list" ).append( '<li>' +
                        '<span class="ui-icon ui-icon-arrowthick-2-n-s"></span>' +
                        '<input type="text" class="item-list-input" value="">' +
                        '<input type="button" class="item-list-remove-button" value="x">' +
                        '</li>' );
            });

            // remove the item from the list when the associated button is pressed
            $(".item-list-remove-button").live( "click", function() {
                $( this ).parent().remove();
            });

            // allows the user to add a return type; once clicked, hides itself
            $( "#add-return-type-button" ).click( function() {
                $( "#return-type-list" ).append( '<li>' +
                        '<input type="text" class="item-list-input" value="">' +
                        '<input type="button" id="remove-return-type-button" value="X">' +
                        '</li>' );
                $( "#add-return-type-button" ).hide();
            });

            // allows the user to remove the return type; once clicked shows the add-return-type button
            $( "#remove-return-type-button" ).live( "click", function() {
                $( this ).parent().remove();
                $( "#add-return-type-button" ).show();
            });

            // resets the create-diffuser form
            $( "#create-diffuser-reset-button" ).click( function() {
                // grab the form used for creating the diffuser
                var $form = $( "#create-diffuser-form" );

                // sets all the form's text input fields to empty
                $form.find( "input[type=text]" ).val( "" );

                // removes all the form's input fields from the lists
                $form.find( "input[class=item-list-input]" ).parent().remove();

                // adds the add-return-type button back, in case it was gone
                $( "#add-return-type-button" ).show();
            });

            function getValues( listId ) {
                var argElems = $( listId ).find( ".item-list-input" ).toArray();
                var arguments = [];
                for( var i = 0; i < argElems.length; ++i ) {
                    arguments.push( $(argElems[ i ]).val() );
                }
                return arguments;
            };

            function getReturnType() {
                var argElems = $( "#return-type-list" ).find( ".item-list-input" ).toArray();
                var argument = "void";
                if( argElems.length > 0 ) {
                    argument = $(argElems[ 0 ]).val()
                }
                return argument;
            };

            function getSerializerName() {
                var serializerName = $( "#serializer-name-list" ).val();
                if( serializerName === null ) {
                    serializerName = "persistence_xml";
                }
                return serializerName;
            }

            function CreateDiffuserRequest( containingClass, methodName, methodArgs, returnType, classPaths, endPoints, serializerName ) {
                this.containingClassName = containingClass;
                this.methodName = methodName;
                this.returnTypeClassName = returnType;
                this.argumentTypes = methodArgs;
                this.classPaths = classPaths;
                this.serializerType = serializerName;
                this.clientEndpoints = endPoints;
            };

            // submits the form to the server
            $( "#create-diffuser-form" ).submit( function() {

                // grab the forms fields
                var containingClass = $( "#containing-class-input" ).val();
                var methodName = $( "#method-name-input" ).val();
                var methodArgs = getValues( "#method-argument-list" );
                var returnType = getReturnType();
                var classPaths = getValues( "#class-path-list" );
                var endPoints = getValues( "#end-points-list" );
                var serializerName = getSerializerName();
                var request = JSON.stringify( new CreateDiffuserRequest( containingClass, methodName, methodArgs, returnType, classPaths, endPoints, serializerName ) );
                alert( request );
                $.ajax({
                    url: diffusersUri,
                    type: "PUT",
                    data: request,
                    dataType: "json",
                    contentType: "application/json"
                });
            });
        });
    </script>

    <title>Restful Diffuser Manager</title>
</head>

<body>
<header>
    <img src="images/web_banner.png">
</header>

<article>
    <div id="tabs">
        <ul>
            <li><a href="#list-diffusers">Diffuser List</a></li>
            <li><a href="#create-diffuser">Create Diffuser</a></li>
            <li><a href="#tabs-3">Manage Diffusers</a></li>
        </ul>

        <div id="list-diffusers">
            <dl id="diffuser-list"></dl>
        </div>
        <div id="create-diffuser">
            <form id="create-diffuser-form">
                <div class="form-element">
                    <p id="containing-class-name">Containing Class Name: <input type="text" id="containing-class-input" size="55"></p>
                    <p class="note">This should be the fully-qualified name of the Java class containing the method.</p>
                    <p id="method-name">Method Name: <input type="text" id="method-name-input"></p>
                    <p id="method-arguments"><input type="button" id="add-arg-type-button" value="+"> Method Arguments</p>
                    <ul class="sortable" id="method-argument-list"></ul>
                    <p id="return-type"><input type="button" id="add-return-type-button" value="+"> Return Type</p>
                    <ul class="sortable" id="return-type-list"></ul>
                </div>
                <div class="form-element">
                    <p id="class-paths"><input type="button" id="add-class-path-button" value="+"> Class-Path</p>
                    <ul class="sortable" id="class-path-list"></ul>
                </div>
                <div class="form-element">
                    <p id="end-points"><input type="button" id="add-end-points-button" value="+"> Diffuser End-Points</p>
                    <ul class="sortable" id="end-points-list"></ul>
                </div>
                <div class="form-element">
                    <p id="serializer-name">Serializer Name:</p>
                    <select id="serializer-name-list"></select>
                </div>
                <div>
                    <input type="submit" id="create-diffuser-submit-button" value="Create">
                    <input type="button" id="create-diffuser-reset-button" value="Reset">
                </div>
            </form>
        </div>
        <div id="tabs-3">
            <p>And what to put here?</p>
        </div>
    </div>
</article>

</body>
</html>                   